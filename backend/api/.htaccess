# backend/api/.htaccess
# Configure clean URL routing for the API

# Enable the rewrite engine
RewriteEngine On

# Set the base path
RewriteBase /

# Set proper CORS headers
<IfModule mod_headers.c>
    # Allow requests from all subdomains
    SetEnvIf Origin "^https?://(my|admin)\.media\.webally\.co\.za$" CORS_ORIGIN=$0
    Header set Access-Control-Allow-Origin "%{CORS_ORIGIN}e" env=CORS_ORIGIN
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-API-Key"
    Header set Access-Control-Allow-Credentials "true"
    
    # If no matching origin was found, use a wildcard (less secure but functional)
    Header set Access-Control-Allow-Origin "*" env=!CORS_ORIGIN
</IfModule>

# Handle OPTIONS requests for CORS preflight
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Rewrite for serving media files (for backwards compatibility)
RewriteRule ^serve\.php$ serve.php [L]

# Explicitly handle /preferences and /media endpoints
RewriteRule ^preferences$ preferences.php [L,QSA]
RewriteRule ^preferences/(.*)$ preferences.php?path=$1 [L,QSA]
RewriteRule ^media$ media.php [L,QSA]
RewriteRule ^media/(.*)$ media.php?path=$1 [L,QSA]

# Rewrite for PHP endpoints (for backwards compatibility)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(media|tags|track|session)\.php(.*)$ $1.php$2 [L,QSA]

# All other requests go through the index.php router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# Prevent directory listing
Options -Indexes